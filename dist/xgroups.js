// ==UserScript==
// @name         XGroups
// @description  Allows adding x.com users to groups, storing in localStorage, and displaying group tags below avatars
// @namespace    https://github.com/artbit/xgroups
// @author       Djordje Ungar
// @copyright    2025+ Djordje Ungar
// @version      1.0.15
// @source       https://github.com/artbit/xgroups
// @updateURL    https://raw.githubusercontent.com/artbit/xgroups/main/dist/xgroups.js
// @downloadURL  https://raw.githubusercontent.com/artbit/xgroups/main/dist/xgroups.js
// @match        https://x.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=x.com
// @tag          productivity
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_notification
// ==/UserScript==

(()=>{let i={tweetSelector:'article[data-testid="tweet"]',usernameSelector:'[data-testid="User-Name"] :nth-child(2) a[href^="/"][role="link"] span',avatarSelector:'div[data-testid="Tweet-User-Avatar"]'},l={groups:'<svg viewBox="0 0 24 24" aria-label="XGroups" role="img"><g><path d="M7.501 19.917L7.471 21H.472l.029-1.027c.184-6.618 3.736-8.977 7-8.977.963 0 1.95.212 2.87.672-.444.478-.851 1.03-1.212 1.656-.507-.204-1.054-.329-1.658-.329-2.767 0-4.57 2.223-4.938 6.004H7.56c-.023.302-.05.599-.059.917zm8.999-8.921c-3.264 0-6.816 2.358-7 8.977L9.471 21h4.528v-2h-2.438c.367-3.781 2.17-6.004 4.938-6.004 1.089 0 2.022.356 2.784 1.004h2.632c-1.376-2.136-3.446-3.004-5.415-3.004zm0-.996c-.799 0-1.527-.279-2.116-.73C13.548 8.63 13 7.632 13 6.5 13 4.57 14.567 3 16.5 3S20 4.57 20 6.5c0 1.132-.548 2.13-1.384 2.77-.589.451-1.317.73-2.116.73zM15 6.5c0 .827.673 1.5 1.5 1.5S18 7.327 18 6.5 17.327 5 16.5 5 15 5.673 15 6.5zm-11 0C4 4.57 5.567 3 7.5 3S11 4.57 11 6.5 9.433 10 7.5 10 4 8.43 4 6.5zm2 0C6 7.327 6.673 8 7.5 8S9 7.327 9 6.5 8.327 5 7.5 5 6 5.673 6 6.5zM21 21h3v-2h-3v-3h-2v3h-3v2h3v3h2v-3z"></path></g></svg>'},g=(()=>{let n="https://api.github.com/gists",e=()=>GM_getValue("xgroups_gist_token",""),a=()=>({Accept:"application/vnd.github.v3+json",Authorization:"token "+e(),"Content-Type":"application/json"});return{createGist:async e=>new Promise((r,o)=>{GM_xmlhttpRequest({url:n,method:"POST",headers:a(),data:JSON.stringify({description:"X.com User Group Tagger Data",public:!1,files:{"xgroups_data.json":{content:JSON.stringify(e,null,2)}}}),onload:e=>{let t;try{t=JSON.parse(e.responseText)}catch(e){o(e)}200!==e.status&&o(new Error("Failed to create Gist"));e=t.id;return GM_setValue("xgroups_gist_id",e),r(e)}})}),readGist:async e=>new Promise((r,o)=>{GM_xmlhttpRequest({url:n+"/"+e,headers:a(),onload:e=>{let t;try{t=JSON.parse(e.responseText)}catch(e){o(e)}e=t.files;r(JSON.parse(e["xgroups_data.json"].content))}})}),updateGist:async(e,t)=>new Promise((r,o)=>{GM_xmlhttpRequest({url:n+"/"+e,method:"PATCH",headers:a(),body:JSON.stringify({files:{"xgroups_data.json":{content:JSON.stringify(t,null,2)}}}),onload:e=>{let t;try{t=JSON.parse(e.responseText)}catch(e){o(e)}200!==e.status&&o(new Error("Failed to update Gist")),r(t.id)}})}),getToken:e,getGistId:()=>GM_getValue("xgroups_gist_id","")}})(),p=({tag:e="div",children:t=[],style:r={},on:o={},...n})=>{let a=document.createElement(e);return Object.entries(n).forEach(([e,t])=>{"className"===e?a.className=t:"textContent"===e?a.textContent=t:"innerHTML"===e?a.innerHTML=t:a.setAttribute(e,t)}),Object.entries(r).forEach(([e,t])=>{a.style[e]=t}),Object.entries(o).forEach(([e,t])=>{a.addEventListener(e,t)}),t.forEach(e=>{e&&("string"==typeof e?a.appendChild(document.createTextNode(e)):e instanceof HTMLElement?a.appendChild(e):a.appendChild(p(e)))}),a},u=e=>{setTimeout(e,1)},c=(e={})=>{GM_notification({title:e.title||"XGroups",text:e.text||"This is the notification message.",...e}),GM_log("Notification: "+e.text)},e=a=>{let t="xgroups_groups",r="xgroups_user_groups",o="xgroups_data_timestamp",n={groups:null,userGroups:null,timestamp:null},s=()=>{try{var e=a.getState().groups;JSON.stringify(e)!==JSON.stringify(n.groups)&&(GM_setValue(t,JSON.stringify(e)),l(),n.groups=e)}catch(e){console.error("Failed to save groups:",e),c({text:"Unable to save group data."})}},i=e=>(e||"").replace("@","").toLowerCase(),l=()=>{var e=Date.now();GM_setValue(o,e.toString())};let p=()=>({groups:a.getState().groups,userGroups:Object.fromEntries(Object.entries(a.getState().userGroups).map(([e,t])=>[e,Array.from(t)])),timestamp:parseInt(GM_getValue(o,"0"),10)});let u=()=>{var e=Object.fromEntries(Object.entries(a.getState().userGroups).map(([e,t])=>[e,Array.from(t)]));try{JSON.stringify(e)!==JSON.stringify(n.userGroups)&&(GM_setValue(r,JSON.stringify(e)),l(),n.userGroups=e)}catch(e){console.error("Failed to save user groups:",e),c({text:"Unable to save user group data."})}};a.setState({groups:(()=>{try{return(JSON.parse(GM_getValue(t,"[]"))||[]).map(e=>({name:e.name,bgColor:e.bgColor||"#777",fgColor:e.fgColor||"#fff",description:e.description||""}))}catch(e){return console.error("Failed to load groups:",e),[]}})(),userGroups:(()=>{try{var e=JSON.parse(GM_getValue(r,"{}"))||{};return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,new Set(t)]))}catch(e){return console.error("Failed to load user groups:",e),{}}})()});return{getGroups:()=>a.getState().groups,addGroup:(e,t="",r="#777",o="#fff")=>{e={name:e,description:t,bgColor:r,fgColor:o};return a.setState({groups:[...a.getState().groups,e]}),s(),e},removeGroup:t=>{a.setState({groups:a.getState().groups.filter(e=>e.name!==t)}),s();let r=a.getState().userGroups;Object.keys(r).forEach(e=>{r[e].delete(t),0===r[e].size&&delete r[e]}),a.setState({userGroups:{...r}}),u()},getUserGroups:e=>Array.from(a.getState().userGroups[i(e)]||[]),getUserLink:e=>"https://x.com/"+i(e),getGroupUsers:t=>Object.keys(a.getState().userGroups).filter(e=>a.getState().userGroups[e].has(t)),addUserToGroup:(e,t)=>{e=i(e);var r=a.getState().userGroups;r[e]=r[e]||new Set,r[e].add(t),a.setState({userGroups:{...r}}),u()},removeUserFromGroup:(e,t)=>{e=i(e);var r=a.getState().userGroups;r[e]&&(r[e].delete(t),0===r[e].size&&delete r[e],a.setState({userGroups:{...r}}),u())},normalizeUsername:i,getLocalData:p,importData:r=>{try{let t=JSON.parse(r);if(!t.groups||!t.userGroups)throw new Error("Invalid JSON format");let e=a.getState().groups,o=a.getState().userGroups;var n=t.groups.filter(t=>!e.some(e=>e.name===t.name));return a.setState({groups:[...e,...n.map(e=>({name:e.name,bgColor:e.bgColor||"#777",fgColor:e.fgColor||"#fff",description:e.description||""}))]}),Object.keys(t.userGroups).forEach(e=>{let r=i(e);o[r]||(o[r]=new Set),t.userGroups[e].forEach(t=>{a.getState().groups.some(e=>e.name===t)&&o[r].add(t)}),0===o[r].size&&delete o[r]}),a.setState({userGroups:{...o}}),l(),u(),s(),!0}catch(e){return console.error("Failed to import data:",e),c({text:"Invalid JSON file or format."}),!1}},syncWithGist:async()=>{if(g.getToken()&&g.getGistId())try{await(async(e,r=3,o=1e3)=>{for(let t=0;t<r;t++)try{return await e()}catch(e){if(t===r-1)throw e;await new Promise(e=>setTimeout(e,o*2**t))}})(async()=>{var e=p(),t=parseInt(e.timestamp||"0",10),r=await g.readGist(g.getGistId()),o=parseInt(r.timestamp||"0",10);if(t<o)a.setState({groups:r.groups,userGroups:Object.fromEntries(Object.entries(r.userGroups).map(([e,t])=>[e,new Set(t)]))}),s(),u();else if(o<t)return g.updateGist(g.getGistId(),e)})}catch(e){console.error("Failed to sync with Gist:",e)}},createGist:async()=>{if(g.getToken())try{var e=p(),t=await g.createGist(e);return GM_setValue("xgroups_gist_id",t),id}catch(e){console.error("Failed to create Gist:",e),c({text:"Failed to create Gist."})}else c({text:"Please set your Gist token in localStorage."})}}};class m{constructor(e,t){this.props=e||{},this.store=t,this.state={},this.element=null,this.unsubscribe=null}setState(e){this.state={...this.state,...e},this.update()}setProps(e){this.props={...this.props,...e},this.update()}render(){return p({tag:"div",textContent:"Base Component"})}mount(e){this.element=this.render(),e.appendChild(this.element),this.store&&(this.unsubscribe=this.store.subscribe(()=>this.update()))}update(){var e;this.element&&(e=this.render(),this.element.replaceWith(e),this.element=e)}unmount(){this.element&&(this.element.remove(),this.element=null),this.unsubscribe&&this.unsubscribe()}}let d={"form-element":"_form-element_1qehq_10","form-input":"_form-input_1qehq_14","group-tags":"_group-tags_1qehq_26","group-tag":"_group-tag_1qehq_26","group-tags-btns":"_group-tags-btns_1qehq_39","group-item":"_group-item_1qehq_49","modal-overlay":"_modal-overlay_1qehq_61","modal-window":"_modal-window_1qehq_73","modal-header":"_modal-header_1qehq_83","form-title":"_form-title_1qehq_90","form-subtitle":"_form-subtitle_1qehq_94",active:"_active_1qehq_103","groups-form":"_groups-form_1qehq_114","group-btn":"_group-btn_1qehq_115","group-text-btn":"_group-text-btn_1qehq_135","label-bg":"_label-bg_1qehq_218",placeholder:"_placeholder_1qehq_235"};class h extends m{render(){let{options:e,...t}=this.props;return p({tag:"select",className:d["form-input"],children:e.map(({label:e,value:t})=>({tag:"option",value:t,textContent:e})),...t})}}class _ extends m{render(){let{type:e,label:t,name:r,value:o="",...n}=this.props;return p({className:d["form-element"],children:[{tag:"input",type:e,name:r,value:o,className:d["form-input"],...n},t&&{tag:"div",className:d["label-bg"],textContent:t},t&&{tag:"label",className:d.placeholder,textContent:t,for:r}]})}}class b extends m{render(){var{on:e,svg:t,style:r,label:o="",ariaLabel:n}=this.props;return p({tag:"div",role:"button",className:d["xgroups-button"],on:e,style:r,"aria-label":n||o,children:[{tag:"div",innerHTML:t},o&&{tag:"span",textContent:o}]})}}class x extends m{render(){let{title:e,subtitle:t,children:r,onClose:o}=this.props;return p({tag:"div",className:d["modal-overlay"],on:{keydown:e=>"Escape"===e.key&&o()},children:[{tag:"div",className:d["modal-window"],children:[{tag:"div",className:d["groups-form"],role:"dialog","aria-modal":"true",style:{position:"relative"},children:[{tag:"div",className:d["modal-header"],children:[{tag:"h2",className:d["form-title"],textContent:e},t&&"string"==typeof t&&{tag:"h3",className:d["form-subtitle"],textContent:t},t&&t instanceof HTMLElement&&{tag:"div",className:d["form-subtitle"],children:[t]}]},{tag:"div",className:d["modal-content"],children:r},{tag:"button",textContent:"✖️","aria-label":"Close modal",style:{position:"absolute",top:"10px",right:"10px"},on:{click:o}}]}]}]})}mount(e){super.mount(e),u(()=>{this.element.classList.add(d.active)}),this.element.focus()}unmount(){this.element&&(this.element.classList.remove(d.active),setTimeout(super.unmount.bind(this),200))}}let t=(a,o)=>{let s=(o=>{let n=new Map;let a=()=>{var e=o.getState().modalsStack;e.length&&e.pop().unmount(),o.setState({modalsStack:e})};return o.subscribe(t=>{t=t.modalsStack;if(t.length){let e=t[t.length-1];t=n.get(e.props.modalName)(e.props,o);e.props.children=[t],e.element.classList.remove(d.active),e.update(),u(()=>{e.element.classList.add(d.active)})}}),{register:(e,t)=>{n.set(e,t)},open:(e,t={})=>{var r=n.get(e);if(!r)throw new Error(`Modal ${e} not registered`);r=r(t,o),e=new x({modalName:e,...t,children:[r],onClose:()=>a()},o),t=o.getState().modalsStack||[];t.push(e),e.mount(document.body),o.setState({modalsStack:t})},close:a}})(o),e=!0;var t=p({tag:"style",id:"xgroups-styles",textContent:':root {\n  --xgroups-background-primary: #0f1419;\n  --xgroups-background-secondary: #30383f;\n  --xgroups-typography-primary: #eee;\n  --xgroups-typography-secondary: #ccc;\n  --xgroups-typography-inverted: #000;\n  --xgroups-ui-primary: #eff3f4;\n  --xgroups-border-radius: 24px;\n}\n._form-element_1qehq_10 {\n  position: relative;\n  margin-top: 28px;\n}\n._form-input_1qehq_14 {\n  background: var(--xgroups-background-secondary);\n  color: var(--xgroups-typography-primary);\n  border: 0;\n  border-radius: var(--xgroups-border-radius);\n  padding: 4px 20px;\n  min-height: 50px;\n  width: 100%;\n}\n._group-circle-btn_1qehq_23:hover {\n  background: var(--xgroups-background-secondary);\n}\n._group-tags_1qehq_26 {\n  margin-top: 5px;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n}\n._group-tag_1qehq_26 {\n  border-radius: 4px;\n  padding: 2px 6px;\n  margin-bottom: 2px;\n  font-size: 16px;\n  cursor: pointer;\n}\n._group-tags-btns_1qehq_39 {\n  gap: 5px;\n  border-top: 1px solid var(--xgroups-background-secondary);\n  padding-top: 5px;\n  margin-top: 5px;\n  visibility: hidden;\n}\narticle[data-testid="tweet"]:hover ._group-tags-btns_1qehq_39 {\n  visibility: visible;\n}\n._group-item_1qehq_49 {\n  display: flex;\n  gap: 8px;\n  justify-content: space-between;\n  padding: 0 8px;\n}\n._group-item_1qehq_49:hover {\n  background: var(--xgroups-background-secondary);\n}\n\n/* MODALS */\n\n._modal-overlay_1qehq_61 {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.8);\n  z-index: 1002;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n._modal-window_1qehq_73 {\n  color: var(--xgroups-typography-primary);\n  background: var(--xgroups-background-primary);\n  border: none;\n  padding: 15px;\n  max-width: 400px;\n  width: 100%;\n  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);\n  border-radius: var(--xgroups-border-radius);\n}\n._modal-header_1qehq_83 {\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  margin-bottom: 10px;\n  flex-direction: column;\n}\n._modal-header_1qehq_83 ._form-title_1qehq_90 {\n  font-size: 20px;\n  margin: 0;\n}\n._modal-header_1qehq_83 ._form-subtitle_1qehq_94 {\n  font-size: 14px;\n  color: #aaa;\n  margin: 0;\n}\n._modal-overlay_1qehq_61 {\n  opacity: 0;\n  transition: opacity 200ms ease-in-out;\n}\n._modal-overlay_1qehq_61._active_1qehq_103 {\n  opacity: 1;\n}\n._modal-window_1qehq_73 {\n  transform: scale(0.8);\n  transition: transform 200ms ease-in-out;\n}\n._modal-overlay_1qehq_61._active_1qehq_103 ._modal-window_1qehq_73 {\n  transform: scale(1);\n}\n\n._groups-form_1qehq_114 input[type="submit"],\n._group-btn_1qehq_115 {\n  background-color: var(--xgroups-ui-primary);\n  color: var(--xgroups-typography-inverted);\n  border-radius: 12px;\n  border: 0;\n  box-sizing: border-box;\n  cursor: pointer;\n  font-size: 14px;\n  margin: 4px;\n  padding: 8px;\n  outline: 0;\n  text-align: center;\n}\n._group-circle-btn_1qehq_23 {\n  width: 42px;\n  height: 42px;\n  background: var(--xgroups-background-primary);\n  border-radius: 42px;\n  padding: 8px;\n}\n._group-text-btn_1qehq_135 {\n  background-color: none;\n  color: var(--xgroups-typography-secondary);\n  border-radius: 12px;\n  border: 0;\n  box-sizing: border-box;\n  cursor: pointer;\n  font-size: 14px;\n  margin: 4px;\n  padding: 4px;\n  outline: 0;\n  text-align: center;\n}\n._group-text-btn_1qehq_135:hover {\n  color: var(--xgroups-typography-primary);\n  text-decoration: underline;\n}\n._groups-form_1qehq_114 {\n  padding: 0px;\n  display: flex;\n  flex-direction: column;\n  gap: 16px;\n  background-color: var(--xgroups-background-primary);\n  border-radius: var(--xgroups-border-radius);\n  box-sizing: border-box;\n}\n._groups-form_1qehq_114 ._form-title_1qehq_90 {\n  color: var(--xgroups-typography-primary);\n  font-family: sans-serif;\n  font-size: 24px;\n  font-weight: 600;\n}\n._groups-form_1qehq_114 select {\n  padding: 12px;\n  border-radius: var(--xgroups-border-radius);\n  background: var(--xgroups-background-secondary);\n}\n._groups-form_1qehq_114 ._form-subtitle_1qehq_94 {\n  color: var(--xgroups-typography-primary);\n  font-family: sans-serif;\n  font-size: 16px;\n  font-weight: 600;\n  margin-top: 10px;\n}\n._groups-form_1qehq_114 ._form-element_1qehq_10 {\n  min-height: 50px;\n  height: auto;\n  position: relative;\n  width: 100%;\n  margin-top: 28px;\n}\n._groups-form_1qehq_114 ._divider_1qehq_186 {\n  width: 100%;\n  height: 1px;\n  background-color: var(--xgroups-background-secondary);\n  margin: 20px 0;\n}\n._groups-form_1qehq_114 ._form-input_1qehq_14,\n._groups-form_1qehq_114 input {\n  color: var(--xgroups-typography-primary);\n  background-color: var(--xgroups-background-secondary);\n  border-radius: var(--xgroups-border-radius);\n  border: 0;\n  box-sizing: border-box;\n  font-size: 18px;\n  min-height: 50px;\n  height: 100%;\n  outline: 0;\n  padding: 4px 20px;\n  width: 100%;\n}\n._groups-form_1qehq_114 input[type="color"] {\n  -webkit-appearance: none;\n  width: 100%;\n  height: 50px;\n}\n._groups-form_1qehq_114 input[type="color"],\n._groups-form_1qehq_114 input[type="color"]::-webkit-color-swatch,\n._groups-form_1qehq_114 input[type="color"]::-webkit-color-swatch-wrapper {\n  border: none;\n  border-radius: var(--xgroups-border-radius);\n  padding: 0;\n}\n._groups-form_1qehq_114 ._label-bg_1qehq_218 {\n  background-color: var(--xgroups-background-primary);\n  border-radius: 10px;\n  padding: 4px 10px;\n  height: 20px;\n  position: absolute;\n  top: -28px;\n  left: 20px;\n  transform: translateY(0);\n  transition: transform 200ms;\n  color: transparent;\n}\n._groups-form_1qehq_114 ._form-input_1qehq_14._focus_1qehq_230 ~ ._label-bg_1qehq_218,\n._groups-form_1qehq_114 input:focus ~ ._label-bg_1qehq_218,\n._groups-form_1qehq_114 input:not(:placeholder-shown) ~ ._label-bg_1qehq_218 {\n  transform: translateY(14px);\n}\n._groups-form_1qehq_114 ._placeholder_1qehq_235 {\n  color: var(--xgroups-typography-secondary);\n  position: absolute;\n  top: 20px;\n  left: 20px;\n  pointer-events: none;\n  transform-origin: 0 50%;\n  transition:\n    transform 200ms,\n    color 200ms;\n  transform: scale(1.2);\n}\n._groups-form_1qehq_114 ._label-bg_1qehq_218,\n._groups-form_1qehq_114 ._placeholder_1qehq_235 {\n  font-family: sans-serif;\n  font-size: 14px;\n  line-height: 14px;\n}\n._groups-form_1qehq_114 ._form-input_1qehq_14._focus_1qehq_230 ~ ._placeholder_1qehq_235,\n._groups-form_1qehq_114 ._form-input_1qehq_14 ._placeholder-shown_1qehq_254,\n._groups-form_1qehq_114 input:focus ~ ._placeholder_1qehq_235,\n._groups-form_1qehq_114 input:not(:placeholder-shown) ~ ._placeholder_1qehq_235 {\n  transform: translateY(-34px) translateX(9px) scale(1);\n}\n._groups-form_1qehq_114 input:not(:placeholder-shown) ~ ._placeholder_1qehq_235 {\n  color: var(--xgroups-typography-secondary);\n}\n._groups-form_1qehq_114 input:focus ~ ._placeholder_1qehq_235 {\n  color: var(--xgroups-typography-tertiary);\n}\n._groups-form_1qehq_114 ._submit_1qehq_265 {\n  background-color: var(--xgroups-ui-primary);\n  color: var(--xgroups-typography-primary);\n  border-radius: 12px;\n  border: 0;\n  box-sizing: border-box;\n  cursor: pointer;\n  font-size: 18px;\n  height: 50px;\n  margin-top: 38px;\n  outline: 0;\n  text-align: center;\n  width: 100%;\n}\n._groups-form_1qehq_114 ._submit_1qehq_265:active {\n  background-color: var(--xgroups-ui-secondary);\n}\n'});document.head.appendChild(t),s.register("groupManager",(e,t)=>p({tag:"div",className:d["groups-form"],children:[{style:{display:"flex",alignItems:"flex-start"},children:[{tag:"button",textContent:"Import",className:d["group-text-btn"],on:{click:()=>{s.open("importData",{title:"Import Data",subtitle:"Paste your JSON data"})}}},{tag:"button",textContent:"Export",className:d["group-text-btn"],on:{click:()=>{var e=a.getLocalData(),e=new Blob([e],{type:"application/json"}),e=URL.createObjectURL(e),t=p({tag:"a",href:e,download:"xgroups.json",style:{display:"none"}});document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}}},{tag:"button",textContent:"Sync...",className:d["group-text-btn"],on:{click:()=>{s.open("gistSettings",{title:"Gist Settings"})}}}]},...t.getState().groups.map(e=>({tag:"div",className:d["group-item"],children:[{tag:"button",textContent:`${e.name} (${a.getGroupUsers(e.name).length})`,title:e.description,on:{click:()=>{s.open("groupUsers",{groupName:e.name,title:"Users in Group: "+e.name,subtitle:e.description})}}},{tag:"div",style:{display:"inline-flex",gap:"5px"},children:[{tag:"button",textContent:"Edit",className:d["group-text-btn"],on:{click:()=>{s.open("editGroup",{group:e,title:"Edit Group"})}}},{tag:"button",textContent:"Remove",className:d["group-text-btn"],on:{click:()=>{0<a.getGroupUsers(e.name).length&&!confirm(`Are you sure you want to remove the group "${e.name}"?`)||a.removeGroup(e.name)}}}]}]})),{tag:"button",textContent:"Add Group",className:d["group-btn"],on:{click:()=>{s.open("addGroup",{title:"Add Group"})}}}]})),s.register("gistSettings",(e,t)=>p({tag:"form",className:d["groups-form"],on:{submit:async e=>{e.preventDefault();var t=e.target.elements.token.value,r=e.target.elements.gistId.value;if("cancel"===e.submitter.name)s.close();else if(t){if(GM_setValue("xgroups_gist_token",t),r)GM_setValue("xgroups_gist_id",r);else try{var o=await a.createGist();o&&c({text:"Gist created: https://gist.github.com/"+o,url:"https://gist.github.com/"+o})}catch(e){return console.error("Failed to create Gist:",e),void c({text:"Failed to create Gist. Check your token."})}await a.syncWithGist(),s.close()}else c({text:"Please enter a GitHub Personal Access Token."})}},children:[new _({type:"text",label:"GitHub Personal Access Token",name:"token",value:GM_getValue("xgroups_gist_token","")},t).render(),new _({type:"text",label:"Gist ID (leave blank to create new)",name:"gistId",value:GM_getValue("xgroups_gist_id","")},t).render(),{tag:"p",children:[{tag:"a",textContent:"Generate new Personal Access Token?",href:"https://github.com/settings/personal-access-tokens/new",target:"_blank",style:{color:"var(--xgroups-ui-primary)",textDecoration:"underline"}},{tag:"span",textContent:" (only allow 'gist' scope)"}]},p({className:d["form-footer"],children:[{tag:"button",type:"submit",name:"cancel",className:d["group-btn"],textContent:"Cancel"},{tag:"button",type:"submit",name:"save",className:d["group-btn"],textContent:"Save"},{tag:"button",type:"button",name:"sync",className:d["group-btn"],textContent:"Sync Now",on:{click:async()=>{var e=await a.syncWithGist();e&&(c({text:"Gist updated: https://gist.github.com/"+e,url:"https://gist.github.com/"+e}),s.close())}}}]})]})),s.register("importData",(e,t)=>p({tag:"form",className:d["groups-form"],on:{submit:e=>{e.preventDefault();e=e.target.elements.jsonData.value;a.importData(e)?s.close():c({text:"Invalid JSON data."})}},children:[{tag:"textarea",className:d["form-input"],placeholder:"Paste your JSON data here",rows:20,on:{input:e=>{e=e.target.value;a.importData(e)&&s.close()}}},{tag:"button",textContent:"Import",className:d["group-btn"],type:"submit"}]})),s.register("editGroup",({group:n},e)=>p({tag:"form",className:d["groups-form"],on:{submit:e=>{e.preventDefault();var t=e.target.elements.name.value,r=e.target.elements.description.value,o=e.target.elements.bgColor.value,e=e.target.elements.fgColor.value;t?(a.removeGroup(n.name),a.addGroup(t,r,o,e),s.close()):c({text:"Please enter a group name."})}},children:[new _({type:"text",label:"Group Name",name:"name",value:n.name},e).render(),new _({type:"text",label:"Description",name:"description",value:n.description},e).render(),new _({type:"color",label:"Background Color",name:"bgColor",value:n.bgColor},e).render(),new _({type:"color",label:"Text Color",name:"fgColor",value:n.fgColor},e).render(),p({className:d["form-footer"],children:[{tag:"button",type:"submit",name:"cancel",className:d["group-btn"],textContent:"Cancel",on:{click:()=>s.close()}},{tag:"button",type:"submit",name:"save",className:d["group-btn"],textContent:"Save Changes"}]})]})),s.register("addGroup",(e,t)=>p({tag:"form",className:d["groups-form"],on:{submit:e=>{e.preventDefault();var t=e.target.elements.name.value,r=e.target.elements.description.value,o=e.target.elements.bgColor.value,e=e.target.elements.fgColor.value;t?(a.addGroup(t,r,o,e),s.close()):c({text:"Please enter a group name."})}},children:[new _({type:"text",label:"Group Name",name:"name"},t).render(),new _({type:"text",label:"Description",name:"description"},t).render(),new _({type:"color",label:"Background Color",name:"bgColor",value:"#777777"},t).render(),new _({type:"color",label:"Text Color",name:"fgColor",value:"#ffffff"},t).render(),p({className:d["form-footer"],children:[{tag:"button",type:"submit",name:"cancel",className:d["group-btn"],textContent:"Cancel",on:{click:()=>s.close()}},{tag:"button",type:"submit",name:"addGroup",className:d["group-btn"],textContent:"Add Group"}]})]})),s.register("groupUsers",(t,e)=>p({tag:"div",className:d["groups-form"],children:[{tag:"div",className:d["group-users-list"],style:{overflowY:"auto",maxHeight:"300px"},children:a.getGroupUsers(t.groupName).map(e=>({tag:"div",className:d["group-item"],children:[{tag:"a",textContent:"@"+e,href:a.getUserLink(e),target:"_blank"},{tag:"button",textContent:"Remove",className:d["group-text-btn"],on:{click:()=>{a.removeUserFromGroup(e,t.groupName)}}}]}))}]})),s.register("assignUser",({username:r},e)=>p({tag:"form",className:d["groups-form"],on:{submit:e=>{e.preventDefault();var t=e.target.elements.group.value;"cancel"===e.submitter.name?s.close():"NEW"===t?(e=prompt("Enter new group name:"))&&(a.addGroup(e),a.addUserToGroup(r,e),s.close()):t?(a.addUserToGroup(r,t),s.close()):c({text:"Please select a group."})}},children:[new _({type:"text",label:"Assign User to Group",name:"username",value:r,readOnly:!0,style:{cursor:"not-allowed"}},e).render(),new h({name:"group",options:[...e.getState().groups.map(e=>({label:e.name+" "+e.description,value:e.name})),{label:"Create New",value:"NEW"}],on:{change:e=>{"NEW"===e.target.value&&s.open("addGroup",{title:"Add New Group"})}}},e).render(),p({className:d["form-footer"],children:[{tag:"button",type:"submit",name:"cancel",className:d["group-btn"],textContent:"Cancel"},{tag:"button",type:"submit",name:"assign",className:d["group-btn"],textContent:"Assign"}]})]})),s.register("removeUser",({username:r},o)=>p({tag:"form",className:d["groups-form"],on:{submit:e=>{e.preventDefault();var t=e.target.elements.group.value;"cancel"===e.submitter.name?s.close():t?(a.removeUserFromGroup(r,t),s.close()):c({text:"Please select a group."})}},children:[new _({type:"text",label:"Remove User from Group",name:"username",value:r,readOnly:!0,style:{cursor:"not-allowed"}},o).render(),new h({name:"group",options:a.getUserGroups(r).map(t=>{var e=o.getState().groups.find(e=>e.name===t);return{label:e.name+" "+e.description,value:e.name}})},o).render(),p({className:d["form-footer"],children:[{tag:"button",type:"submit",name:"cancel",className:d["group-btn"],textContent:"Cancel"},{tag:"button",type:"submit",name:"remove",className:d["group-btn"],textContent:"Remove"}]})]}));class n extends m{render(){let e=this.props.username;var t=a.getUserGroups(e);return p({className:d["group-tags"],children:[...t.map(t=>{let e=this.store.getState().groups.find(e=>e.name===t);return p({tag:"span",className:d["group-tag"],textContent:e.name,title:e.description,style:{background:e.bgColor,color:e.fgColor},on:{click:()=>s.open("groupUsers",{groupName:e.name,title:"Users in Group: "+e.name,subtitle:p({tag:"button",textContent:"Edit",on:{click:()=>s.open("editGroup",{group:e,title:"Edit Group"})},style:{cursor:"pointer"},className:d["group-tag-edit"]}),subtitle:e.description})}})}),{className:d["group-tags-btns"],children:[{tag:"button",textContent:"➕","aria-label":"+ Add user to group",on:{click:()=>s.open("assignUser",{username:e,title:"Add to Group"})}},{tag:"button",textContent:"➖","aria-label":"- Remove user from group",on:{click:()=>s.open("removeUser",{username:e,title:"Remove User from Group"})}}]}]})}}t=()=>{e=!1,document.querySelectorAll(i.tweetSelector).forEach(e=>{var t,r=e.querySelector(i.usernameSelector)||e.querySelector('a[href^="/"][role="link"] span');r&&(r=a.normalizeUsername(r.textContent),e=e.querySelector(i.avatarSelector))&&((t=e.querySelector("."+d["group-tags"]))&&t.remove(),new n({username:r},o).mount(e))}),setTimeout(()=>{e=!0},1)};new b({svg:l.groups,style:{position:"fixed",top:"10px",right:"10px",width:"24px",height:"24px",fill:"var(--xgroups-ui-primary)",zIndex:1001},on:{click:()=>s.open("groupManager",{title:"Manage Groups"})}},o).mount(document.body),t(),a.syncWithGist();let r=((t,r)=>{let o;return(...e)=>{clearTimeout(o),o=setTimeout(()=>t(...e),r)}})(t,100);return new MutationObserver(()=>{e&&r()}).observe(document.body,{childList:!0,subtree:!0}),o.subscribe(e=>{(e.groups||e.userGroups)&&r()}),{updateGroupTags:r}};class r{constructor(){this.store=(e=>{let t={...e},r=new Set;return{getState:()=>t,setState:e=>{t={...t,...e},r.forEach(e=>e(t))},subscribe:e=>(r.add(e),()=>r.delete(e))}})({groups:[],userGroups:{},modalsStack:[]}),this.dataAPI=e(this.store),this.uiManager=t(this.dataAPI,this.store)}}new r})();